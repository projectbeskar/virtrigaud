#!/bin/bash
# Pre-commit hook for virtrigaud
# This script runs formatting, linting, and CRD generation checks before commits

set -e

echo "ğŸ”§ Running pre-commit checks..."

# Track if any CRD type files were modified
CRD_TYPES_CHANGED=false
for file in $(git diff --cached --name-only --diff-filter=ACM); do
    if [[ "$file" == api/infra.virtrigaud.io/v1beta1/*_types.go ]]; then
        CRD_TYPES_CHANGED=true
        echo "ğŸ“‹ Detected CRD type change: $file"
    fi
done

# If CRD types changed, regenerate CRDs and manifests
if [ "$CRD_TYPES_CHANGED" = true ]; then
    echo "ğŸ”„ CRD types changed - regenerating CRD YAMLs and DeepCopy methods..."

    # Generate DeepCopy methods
    echo "  1. Generating DeepCopy methods..."
    make generate || {
        echo "âŒ Failed to generate DeepCopy methods"
        exit 1
    }

    # Generate CRD manifests
    echo "  2. Generating CRD YAML manifests..."
    make manifests || {
        echo "âŒ Failed to generate CRD manifests"
        exit 1
    }

    # Sync CRDs to Helm chart
    echo "  3. Syncing CRDs to Helm chart..."
    make sync-helm-crds || {
        echo "âŒ Failed to sync Helm CRDs"
        exit 1
    }

    # Add generated files to the commit
    echo "  4. Adding generated files to commit..."
    git add api/**/zz_generated.deepcopy.go
    git add config/crd/bases/*.yaml
    git add charts/virtrigaud/crds/*.yaml

    echo "âœ… CRD regeneration complete - generated files added to commit"
fi

# Format code
echo "ğŸ“ Formatting code..."
if command -v gofumpt &> /dev/null; then
    gofumpt -l -w .
else
    make fmt
fi

# Organize imports
if command -v gci &> /dev/null; then
    gci write --skip-generated .
else
    echo "âš ï¸  gci not found, skipping import organization"
fi

# Add formatted files to commit if any were changed
git diff --name-only | grep '\.go$' | xargs -r git add || true

# Run linter
echo "ğŸ” Running linter..."
make lint-check || {
    echo "âŒ Linting failed - please fix issues before committing"
    exit 1
}

echo "âœ… Pre-commit checks passed!"
