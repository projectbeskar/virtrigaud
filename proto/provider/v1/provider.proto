syntax = "proto3";
package provider.v1;
option go_package = "github.com/projectbeskar/virtrigaud/internal/rpc/provider/v1;providerv1";

// Power operations enum
enum PowerOp {
  POWER_OP_UNSPECIFIED = 0;
  POWER_OP_ON = 1;
  POWER_OP_OFF = 2;
  POWER_OP_REBOOT = 3;
}

// Task reference for async operations
message TaskRef {
  string id = 1;
}

// Empty message for operations with no parameters
message Empty {}

// Validate provider connectivity and configuration
message ValidateRequest {}
message ValidateResponse {
  bool ok = 1;
  string message = 2;
}

// Create a new virtual machine
message CreateRequest {
  string name = 1;
  bytes user_data = 2; // Already rendered cloud-init/ignition data
  
  // JSON-encoded provider-agnostic specifications
  string class_json = 3;     // VMClass
  string image_json = 4;     // VMImage  
  string networks_json = 5;  // []NetworkAttachment
  string disks_json = 6;     // []DiskSpec
  string placement_json = 7; // Placement
  repeated string tags = 8;  // Tags
}

message CreateResponse {
  string id = 1;       // Provider-specific VM identifier
  TaskRef task = 2;    // Optional task reference for async operations
}

// Delete a virtual machine
message DeleteRequest {
  string id = 1;
}

// Power control operations
message PowerRequest {
  string id = 1;
  PowerOp op = 2;
}

// Reconfigure virtual machine resources
message ReconfigureRequest {
  string id = 1;
  string desired_json = 2; // JSON-encoded desired state
}

// Generic task response for async operations
message TaskResponse {
  TaskRef task = 1;
}

// Describe virtual machine current state
message DescribeRequest {
  string id = 1;
}

message DescribeResponse {
  bool exists = 1;
  string power_state = 2;
  repeated string ips = 3;
  string console_url = 4;
  string provider_raw_json = 5; // Provider-specific additional data
}

// Check async task status
message TaskStatusRequest {
  TaskRef task = 1;
}

message TaskStatusResponse {
  bool done = 1;
  string error = 2; // Error message if task failed
}

// Snapshot operations
message SnapshotCreateRequest {
  string vm_id = 1;
  string name_hint = 2;
  bool include_memory = 3; // Include memory state if supported
  string description = 4;
}

message SnapshotCreateResponse {
  string snapshot_id = 1;
  TaskRef task = 2;
}

message SnapshotDeleteRequest {
  string vm_id = 1;
  string snapshot_id = 2;
}

message SnapshotRevertRequest {
  string vm_id = 1;
  string snapshot_id = 2;
}

// Clone operations
message CloneRequest {
  string source_vm_id = 1;
  string target_name = 2;
  bool linked = 3; // Best-effort linked clone
  
  // JSON-encoded specifications for customization
  string class_json = 4;     // VMClass overrides
  string placement_json = 5; // Placement hints
  string customize_json = 6; // Customization spec
}

message CloneResponse {
  string target_vm_id = 1;
  TaskRef task = 2;
}

// Image preparation operations
message ImagePrepareRequest {
  string image_json = 1; // JSON-encoded VMImage spec
  string target_name = 2; // Target template/image name
  string storage_hint = 3; // Storage location hint (datastore, pool, etc.)
}

// Capability check - what features does this provider support
message GetCapabilitiesRequest {}

message GetCapabilitiesResponse {
  bool supports_reconfigure_online = 1;
  bool supports_disk_expansion_online = 2;
  bool supports_snapshots = 3;
  bool supports_memory_snapshots = 4;
  bool supports_linked_clones = 5;
  bool supports_image_import = 6;
  repeated string supported_disk_types = 7;
  repeated string supported_network_types = 8;
}

// Provider service definition
service Provider {
  // Validate provider configuration and connectivity
  rpc Validate(ValidateRequest) returns (ValidateResponse);
  
  // Create a new virtual machine
  rpc Create(CreateRequest) returns (CreateResponse);
  
  // Delete a virtual machine
  rpc Delete(DeleteRequest) returns (TaskResponse);
  
  // Perform power operations on a virtual machine
  rpc Power(PowerRequest) returns (TaskResponse);
  
  // Reconfigure virtual machine resources
  rpc Reconfigure(ReconfigureRequest) returns (TaskResponse);
  
  // Describe current virtual machine state
  rpc Describe(DescribeRequest) returns (DescribeResponse);
  
  // Check the status of an async task
  rpc TaskStatus(TaskStatusRequest) returns (TaskStatusResponse);
  
  // Snapshot operations
  rpc SnapshotCreate(SnapshotCreateRequest) returns (SnapshotCreateResponse);
  rpc SnapshotDelete(SnapshotDeleteRequest) returns (TaskResponse);
  rpc SnapshotRevert(SnapshotRevertRequest) returns (TaskResponse);
  
  // Clone operations
  rpc Clone(CloneRequest) returns (CloneResponse);
  
  // Image preparation and import
  rpc ImagePrepare(ImagePrepareRequest) returns (TaskResponse);
  
  // Get provider capabilities
  rpc GetCapabilities(GetCapabilitiesRequest) returns (GetCapabilitiesResponse);
}
