# Complete example showing how to create a VM with vSphere provider (v0.2.1+)
# Demonstrates all major v0.2.1 features:
# - OffGraceful shutdown support
# - Hardware version management  
# - Proper disk sizing
# - Enhanced lifecycle management

# First, create the credentials secret
apiVersion: v1
kind: Secret
metadata:
  name: vsphere-creds
  namespace: default
type: Opaque
stringData:
  username: "administrator@vsphere.local"
  password: "your-password-here"

---
# Define the vSphere provider
apiVersion: infra.virtrigaud.io/v1beta1
kind: Provider
metadata:
  name: vsphere-prod
  namespace: default
spec:
  type: vsphere
  endpoint: https://vcenter.example.com/sdk
  credentialSecretRef:
    name: vsphere-creds
  insecureSkipVerify: false  # Set to true for dev/test environments
  defaults:
    datastore: datastore1
    cluster: compute-cluster-a
    folder: virtrigaud-vms
  runtime:
    mode: Remote
    image: "ghcr.io/projectbeskar/virtrigaud/provider-vsphere:v0.2.3"
    service:
      port: 9090

---
# Define a VM class for resource allocation (v0.2.1+ features)
apiVersion: infra.virtrigaud.io/v1beta1
kind: VMClass
metadata:
  name: small
  namespace: default
spec:
  cpu: 2
  memory: "4Gi"
  firmware: UEFI
  diskDefaults:
    type: thin
    size: "40Gi"  # v0.2.1: Disk size now properly respected across all providers
  guestToolsPolicy: install
  extraConfig:
    # Time synchronization
    "tools.syncTime": "true"
    "time.synchronize.continue": "true"
    # v0.2.1: Hardware version management (vSphere only)
    "vsphere.hardwareVersion": "19"  # ESXi 7.0 U2+ compatibility

---
# Define the VM image/template
apiVersion: infra.virtrigaud.io/v1beta1
kind: VMImage
metadata:
  name: ubuntu-22-template
  namespace: default
spec:
  source:
    vsphere:
      templateName: "ubuntu-22.04-cloudimg"
  prepare:
    onMissing: Fail  # Template must already exist

---
# Define network attachment
apiVersion: infra.virtrigaud.io/v1beta1
kind: VMNetworkAttachment
metadata:
  name: app-network
  namespace: default
spec:
  network:
    vsphere:
      portgroup: "VM Network"
  ipAllocation:
    type: DHCP

---
# Create the virtual machine
apiVersion: infra.virtrigaud.io/v1beta1
kind: VirtualMachine
metadata:
  name: demo-web-server
  namespace: default
spec:
  providerRef:
    name: vsphere-prod
  classRef:
    name: small
  imageRef:
    name: ubuntu-22-template
  networks:
    - name: app-network
      networkRef:
        name: app-network
  disks:
    - name: data-disk
      sizeGiB: 100
      type: thin
  powerState: "On"
  
  # v0.2.1: Enhanced lifecycle management
  lifecycle:
    gracefulShutdownTimeout: "90s"  # 90 seconds for graceful shutdown
    preStop:
      exec:
        command:
        - "/bin/bash"
        - "-c"
        - |
          # Graceful shutdown sequence
          echo "$(date): Starting graceful shutdown" >> /var/log/shutdown.log
          systemctl stop apache2 || true
          sync
          echo "$(date): Graceful shutdown complete" >> /var/log/shutdown.log
  
  userData:
    cloudInit:
      inline: |
        #cloud-config
        hostname: demo-web-server
        fqdn: demo-web-server.example.com
        
        users:
          - name: admin
            sudo: ALL=(ALL) NOPASSWD:ALL
            shell: /bin/bash
            ssh_authorized_keys:
              - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAB... # Add your SSH key here
              
        packages:
          - curl
          - wget
          - nginx
          - htop
          
        runcmd:
          - systemctl enable nginx
          - systemctl start nginx
          - echo "<h1>Hello from virtrigaud!</h1>" > /var/www/html/index.html
          - ufw allow 22/tcp
          - ufw allow 80/tcp
          - ufw --force enable
          
        final_message: "VM is ready! SSH: ssh admin@<ip>"
        
  tags:
    - environment:demo
    - application:web
    - managed-by:virtrigaud
  
  placement:
    datastore: datastore1
    cluster: compute-cluster-a
    folder: demo-vms

---
# v0.2.1 Usage Examples:

# 1. Graceful shutdown (uses preStop hook + VMware Tools):
# kubectl patch virtualmachine demo-web-server --type='merge' -p='{"spec":{"powerState":"OffGraceful"}}'

# 2. Regular hard shutdown:
# kubectl patch virtualmachine demo-web-server --type='merge' -p='{"spec":{"powerState":"Off"}}'

# 3. Start VM:
# kubectl patch virtualmachine demo-web-server --type='merge' -p='{"spec":{"powerState":"On"}}'

# 4. Check VM status:
# kubectl get virtualmachine demo-web-server -o yaml
