name: Runtime Chart

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'charts/virtrigaud-provider-runtime/**'
      - '.github/workflows/runtime-chart.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'charts/virtrigaud-provider-runtime/**'
      - '.github/workflows/runtime-chart.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  GO_VERSION: '1.23'

jobs:
  lint:
    name: Lint Runtime Chart
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Helm
      uses: azure/setup-helm@v4
      with:
        version: 'latest'

    - name: Lint chart
      run: helm lint charts/virtrigaud-provider-runtime/

    - name: Template chart with mock provider values
      run: |
        helm template test-mock charts/virtrigaud-provider-runtime/ \
          -f charts/virtrigaud-provider-runtime/examples/values-mock.yaml

    - name: Template chart with vSphere provider values
      run: |
        helm template test-vsphere charts/virtrigaud-provider-runtime/ \
          -f charts/virtrigaud-provider-runtime/examples/values-vsphere.yaml

    - name: Template chart with libvirt provider values
      run: |
        helm template test-libvirt charts/virtrigaud-provider-runtime/ \
          -f charts/virtrigaud-provider-runtime/examples/values-libvirt.yaml

    - name: Template chart with proxmox provider values
      run: |
        helm template test-proxmox charts/virtrigaud-provider-runtime/ \
          -f charts/virtrigaud-provider-runtime/examples/values-proxmox.yaml

  kind-test:
    name: Kind Integration Test
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    needs: lint
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod
        cache: true

    - name: Set up Helm
      uses: azure/setup-helm@v4
      with:
        version: 'latest'

    - name: Install kind
      run: |
        # Download and install kind
        curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.22.0/kind-linux-amd64
        chmod +x ./kind
        sudo mv ./kind /usr/local/bin/kind
        
        # Verify installation
        kind --version

    - name: Create kind cluster
      run: |
        echo "🚀 Creating kind cluster..."
        kind create cluster --name runtime-test --wait 60s
        
        echo "✅ Cluster created successfully"
        kind get clusters

    - name: Configure kubectl for kind cluster
      run: |
        echo "🔧 Configuring kubectl for kind cluster..."
        kind get kubeconfig --name runtime-test > /tmp/kubeconfig
        export KUBECONFIG=/tmp/kubeconfig
        echo "KUBECONFIG=/tmp/kubeconfig" >> $GITHUB_ENV
        
        echo "✅ Testing kubectl connection..."
        kubectl config current-context
        kubectl get nodes
        kubectl cluster-info

    - name: Build mock provider image
      run: |
        make build-provider-mock
        docker build -f cmd/provider-mock/Dockerfile -t provider-mock:test .
        kind load docker-image provider-mock:test --name runtime-test

    - name: Install runtime chart with mock provider
      run: |
        helm install test-runtime charts/virtrigaud-provider-runtime/ \
          --set image.repository=provider-mock \
          --set image.tag=test \
          --set image.pullPolicy=Never \
          --wait --timeout=5m

    - name: Verify deployment is ready
      run: |
        kubectl get pods
        kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=virtrigaud-provider-runtime --timeout=60s

    - name: Test health endpoint
      run: |
        kubectl port-forward svc/test-runtime-virtrigaud-provider-runtime 8080:8080 &
        PF_PID=$!
        sleep 5
        
        # Test health endpoint (assuming mock provider has HTTP health check)
        curl -f http://localhost:8080/health || echo "Health check not available via HTTP"
        
        kill $PF_PID || true

    - name: Test gRPC service
      run: |
        kubectl port-forward svc/test-runtime-virtrigaud-provider-runtime 9443:9443 &
        PF_PID=$!
        sleep 5
        
        # Test gRPC health (using grpcurl if available)
        if command -v grpcurl >/dev/null 2>&1; then
          grpcurl -plaintext localhost:9443 grpc.health.v1.Health/Check || echo "gRPC health check failed"
        else
          echo "grpcurl not available, skipping gRPC health check"
        fi
        
        kill $PF_PID || true

    - name: Check logs
      if: failure()
      run: |
        echo "🔍 Checking cluster status and logs..."
        
        # Ensure kubectl is configured for kind cluster
        if [ ! -f "/tmp/kubeconfig" ]; then
          echo "⚠️  Kubeconfig not found, attempting to recreate..."
          kind get kubeconfig --name runtime-test > /tmp/kubeconfig || echo "Failed to get kubeconfig"
        fi
        export KUBECONFIG=/tmp/kubeconfig
        
        echo "📋 Cluster context and nodes:"
        kubectl config current-context || echo "No current context"
        kubectl get nodes || echo "Failed to get nodes"
        
        echo "📋 Pod status:"
        kubectl describe pods || echo "Failed to describe pods"
        
        echo "📋 Application logs:"
        kubectl logs -l app.kubernetes.io/name=virtrigaud-provider-runtime || echo "No logs found"

    - name: Clean up
      if: always()
      run: |
        helm uninstall test-runtime || true

  package:
    name: Package Chart
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    needs: [lint, kind-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Helm
      uses: azure/setup-helm@v4
      with:
        version: 'latest'

    - name: Package chart
      run: |
        mkdir -p dist
        helm package charts/virtrigaud-provider-runtime/ -d dist/

    - name: Upload chart artifact
      uses: actions/upload-artifact@v4
      with:
        name: runtime-chart
        path: dist/*.tgz

  crd-installation-test:
    name: CRD Installation Test
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: '3.12.0'

    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'

    - name: Create kind cluster
      uses: helm/kind-action@v1.10.0
      with:
        cluster_name: crd-test
        kubectl_version: v1.28.0

    - name: Test CRD installation via Helm
      run: |
        echo "🧪 Testing CRD installation..."
        
        # Test installing CRDs via main virtrigaud chart (CRDs only)
        helm install virtrigaud-crds ./charts/virtrigaud \
          --set manager.replicaCount=0 \
          --set providers.libvirt.enabled=false \
          --set providers.vsphere.enabled=false \
          --set webhooks.enabled=false \
          --wait --timeout=5m
        
        # Verify CRDs are installed
        echo "🔍 Verifying CRDs are installed..."
        kubectl get crd | grep virtrigaud.io
        
        # Test CRD functionality by creating sample resources
        echo "🧪 Testing CRD functionality..."
        
        # Create a secret for credentials
        kubectl create secret generic test-credentials \
          --from-literal=username=test \
          --from-literal=password=test
        
        kubectl apply -f - <<EOF
        apiVersion: infra.virtrigaud.io/v1beta1
        kind: Provider
        metadata:
          name: test-provider
        spec:
          type: proxmox
          endpoint: http://localhost:9443
          credentialSecretRef:
            name: test-credentials
        EOF
        
        # Verify resource was created
        kubectl get provider test-provider
        
        # Clean up
        kubectl delete provider test-provider
        kubectl delete secret test-credentials
        helm uninstall virtrigaud-crds
