name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release'
        required: true
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_PREFIX: projectbeskar/virtrigaud

permissions:
  contents: write
  packages: write
  id-token: write
  security-events: write

jobs:
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.get-tag.outputs.tag }}
      version: ${{ steps.get-tag.outputs.version }}
    steps:
    - name: Get tag
      id: get-tag
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          TAG="${{ github.event.inputs.tag }}"
        else
          TAG="${{ github.ref_name }}"
        fi
        VERSION=${TAG#v}
        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        echo "version=${VERSION}" >> $GITHUB_OUTPUT

  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    needs: prepare
    timeout-minutes: 30
    strategy:
      matrix:
        component: [manager, provider-libvirt, provider-vsphere, provider-proxmox, kubectl]
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: |
          network=host

    - name: Wait and retry Docker login
      run: |
        echo "Attempting Docker login with retry logic..."
        for i in {1..3}; do
          echo "Login attempt $i/3"
          if docker login ${{ env.REGISTRY }} -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }}; then
            echo "Login successful on attempt $i"
            break
          else
            echo "Login attempt $i failed"
            if [ $i -eq 3 ]; then
              echo "All login attempts failed"
              exit 1
            fi
            echo "Waiting 30 seconds before retry..."
            sleep 30
          fi
        done

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_PREFIX }}/${{ matrix.component }}
        tags: |
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=ref,event=tag

    - name: Determine Dockerfile path
      id: dockerfile
      run: |
        if [ "${{ matrix.component }}" = "manager" ]; then
          echo "path=./build/Dockerfile.manager" >> $GITHUB_OUTPUT
        elif [ "${{ matrix.component }}" = "kubectl" ]; then
          echo "path=./build/Dockerfile.kubectl" >> $GITHUB_OUTPUT
        else
          echo "path=./cmd/${{ matrix.component }}/Dockerfile" >> $GITHUB_OUTPUT
        fi

    - name: Build and push
      id: build
      uses: docker/build-push-action@v6
      timeout-minutes: 20
      with:
        context: .
        file: ${{ steps.dockerfile.outputs.path }}
        platforms: linux/amd64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        # Disable GitHub Actions cache due to reliability issues
        # cache-from: type=gha
        # cache-to: type=gha,mode=max
        provenance: mode=max
        sbom: true

    - name: Install Cosign
      uses: sigstore/cosign-installer@v3

    - name: Sign image
      run: |
        cosign sign --yes ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_PREFIX }}/${{ matrix.component }}@${{ steps.build.outputs.digest }}

  security-scan:
    name: Security Scan Images
    runs-on: ubuntu-latest
    needs: [prepare, build-and-push]
    timeout-minutes: 20
    strategy:
      matrix:
        component: [manager, provider-libvirt, provider-vsphere, provider-proxmox, kubectl]
    steps:
    - name: Retry Docker login for security scan
      run: |
        echo "Attempting Docker login for security scan..."
        for i in {1..3}; do
          echo "Login attempt $i/3"
          if docker login ${{ env.REGISTRY }} -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }}; then
            echo "Login successful on attempt $i"
            break
          else
            echo "Login attempt $i failed"
            if [ $i -eq 3 ]; then
              echo "All login attempts failed"
              exit 1
            fi
            echo "Waiting 30 seconds before retry..."
            sleep 30
          fi
        done

    - name: Wait for image propagation
      run: |
        echo "Waiting for image to be available in registry..."
        sleep 30
        
        # Verify image exists before scanning
        for i in {1..5}; do
          if docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_PREFIX }}/${{ matrix.component }}:${{ needs.prepare.outputs.tag }} > /dev/null 2>&1; then
            echo "Image is available"
            break
          fi
          echo "Attempt $i: Image not yet available, waiting..."
          sleep 30
        done

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_PREFIX }}/${{ matrix.component }}:${{ needs.prepare.outputs.tag }}
        format: 'sarif'
        output: 'trivy-results-${{ matrix.component }}.sarif'

    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results-${{ matrix.component }}.sarif'

    - name: Run Trivy for high/critical vulnerabilities
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_PREFIX }}/${{ matrix.component }}:${{ needs.prepare.outputs.tag }}
        format: 'table'
        # kubectl image uses official K8s binary - don't fail on its vulnerabilities
        exit-code: ${{ matrix.component == 'kubectl' && '0' || '1' }}
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'

  generate-sbom:
    name: Generate SBOMs
    runs-on: ubuntu-latest
    needs: [prepare, build-and-push]
    timeout-minutes: 15
    strategy:
      matrix:
        component: [manager, provider-libvirt, provider-vsphere, provider-proxmox, kubectl]
    steps:
    - name: Retry Docker login for SBOM generation
      run: |
        echo "Attempting Docker login for SBOM generation..."
        for i in {1..3}; do
          echo "Login attempt $i/3"
          if docker login ${{ env.REGISTRY }} -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }}; then
            echo "Login successful on attempt $i"
            break
          else
            echo "Login attempt $i failed"
            if [ $i -eq 3 ]; then
              echo "All login attempts failed"
              exit 1
            fi
            echo "Waiting 30 seconds before retry..."
            sleep 30
          fi
        done

    - name: Wait for image propagation
      run: |
        echo "Waiting for image to be available in registry..."
        sleep 30
        
        # Verify image exists before generating SBOM
        for i in {1..5}; do
          if docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_PREFIX }}/${{ matrix.component }}:${{ needs.prepare.outputs.tag }} > /dev/null 2>&1; then
            echo "Image is available"
            break
          fi
          echo "Attempt $i: Image not yet available, waiting..."
          sleep 30
        done

    - name: Generate SBOM
      uses: anchore/sbom-action@v0
      with:
        image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_PREFIX }}/${{ matrix.component }}:${{ needs.prepare.outputs.tag }}
        format: spdx-json
        output-file: sbom-${{ matrix.component }}.spdx.json

    - name: Upload SBOM
      uses: actions/upload-artifact@v4
      with:
        name: sbom-${{ matrix.component }}
        path: sbom-${{ matrix.component }}.spdx.json

  build-helm-chart:
    name: Build and Package Helm Chart
    runs-on: ubuntu-latest
    needs: prepare
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Helm
      uses: azure/setup-helm@v3
      with:
        version: '3.12.0'

    - name: Update chart version
      run: |
        sed -i "s/version: .*/version: ${{ needs.prepare.outputs.version }}/" charts/virtrigaud/Chart.yaml
        sed -i "s/appVersion: .*/appVersion: \"${{ needs.prepare.outputs.tag }}\"/" charts/virtrigaud/Chart.yaml
        
        # Update VirtRigaud component image tags in values.yaml (but not kubectl image)
        # Update manager image tag (use line range to be precise)
        MANAGER_START=$(grep -n "^manager:" charts/virtrigaud/values.yaml | cut -d: -f1)
        MANAGER_END=$((MANAGER_START + 10))
        sed -i "${MANAGER_START},${MANAGER_END} s/    tag: \".*\"/    tag: \"${{ needs.prepare.outputs.tag }}\"/" charts/virtrigaud/values.yaml
        # Update provider image tags (use line ranges to be precise)
        LIBVIRT_START=$(grep -n "^  libvirt:" charts/virtrigaud/values.yaml | cut -d: -f1)
        LIBVIRT_END=$((LIBVIRT_START + 15))
        sed -i "${LIBVIRT_START},${LIBVIRT_END} s/      tag: \".*\"/      tag: \"${{ needs.prepare.outputs.tag }}\"/" charts/virtrigaud/values.yaml
        VSPHERE_START=$(grep -n "^  vsphere:" charts/virtrigaud/values.yaml | cut -d: -f1)
        VSPHERE_END=$((VSPHERE_START + 15))
        sed -i "${VSPHERE_START},${VSPHERE_END} s/      tag: \".*\"/      tag: \"${{ needs.prepare.outputs.tag }}\"/" charts/virtrigaud/values.yaml
        PROXMOX_START=$(grep -n "^  proxmox:" charts/virtrigaud/values.yaml | cut -d: -f1)
        PROXMOX_END=$((PROXMOX_START + 15))
        sed -i "${PROXMOX_START},${PROXMOX_END} s/      tag: \".*\"/      tag: \"${{ needs.prepare.outputs.tag }}\"/" charts/virtrigaud/values.yaml
        # Update crdUpgrade kubectl image to point to our built image (using line numbers to be precise)
        CRDUPGRADE_START=$(grep -n "^crdUpgrade:" charts/virtrigaud/values.yaml | cut -d: -f1)
        CRDUPGRADE_END=$((CRDUPGRADE_START + 20))
        sed -i "${CRDUPGRADE_START},${CRDUPGRADE_END} { s|repository: ghcr.io/projectbeskar/virtrigaud/kubectl|repository: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_PREFIX }}/kubectl|; s/tag: \"v.*\"/tag: \"${{ needs.prepare.outputs.tag }}\"/; }" charts/virtrigaud/values.yaml

    - name: Sync CRDs to Helm chart
      run: |
        # Ensure Helm chart has latest CRDs before packaging
        make sync-helm-crds

    - name: Package chart
      run: |
        mkdir -p helm-packages
        helm package charts/virtrigaud --destination ./helm-packages/

    - name: Upload chart
      uses: actions/upload-artifact@v4
      with:
        name: helm-chart
        path: helm-packages/*.tgz

  build-cli-tools:
    name: Build CLI Tools
    runs-on: ubuntu-latest
    needs: prepare
    timeout-minutes: 15
    strategy:
      matrix:
        os: [linux, darwin, windows]
        arch: [amd64, arm64]
        exclude:
          - os: windows
            arch: arm64
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod
        cache: true

    - name: Build CLI tools
      run: |
        mkdir -p dist
        
        # Set extension for Windows
        EXT=""
        if [ "${{ matrix.os }}" = "windows" ]; then
          EXT=".exe"
        fi
        
        # Build each tool
        for tool in vrtg vcts virtrigaud-loadgen vrtg-provider; do
          GOOS=${{ matrix.os }} GOARCH=${{ matrix.arch }} go build \
            -ldflags="-s -w -X 'main.version=${{ needs.prepare.outputs.tag }}'" \
            -o dist/${tool}-${{ matrix.os }}-${{ matrix.arch }}${EXT} \
            ./cmd/${tool}
        done

    - name: Upload CLI tools
      uses: actions/upload-artifact@v4
      with:
        name: cli-tools-${{ matrix.os }}-${{ matrix.arch }}
        path: dist/*

  generate-changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    needs: prepare
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Generate changelog
      id: changelog
      run: |
        # Get the previous tag
        PREV_TAG=$(git tag --sort=version:refname | grep -B1 ${{ needs.prepare.outputs.tag }} | head -1)
        if [ -z "$PREV_TAG" ] || [ "$PREV_TAG" = "${{ needs.prepare.outputs.tag }}" ]; then
          PREV_TAG=$(git rev-list --max-parents=0 HEAD)
        fi
        
        # Generate changelog
        cat > CHANGELOG.md << EOF
        # Changelog for ${{ needs.prepare.outputs.tag }}
        
        ## What's Changed
        
        $(git log --pretty=format:"- %s (%h)" ${PREV_TAG}..${{ needs.prepare.outputs.tag }} | head -20)
        
        ## Container Images
        
        - Manager: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME_PREFIX }}/manager:${{ needs.prepare.outputs.tag }}\`
        - Provider Libvirt: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME_PREFIX }}/provider-libvirt:${{ needs.prepare.outputs.tag }}\`
        - Provider vSphere: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME_PREFIX }}/provider-vsphere:${{ needs.prepare.outputs.tag }}\`
        - Provider Proxmox: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME_PREFIX }}/provider-proxmox:${{ needs.prepare.outputs.tag }}\`
        - Kubectl: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME_PREFIX }}/kubectl:${{ needs.prepare.outputs.tag }}\`
        
        ## Installation
        
        \`\`\`bash
        helm registry login ${{ env.REGISTRY }} -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }}
        helm install virtrigaud oci://${{ env.REGISTRY }}/${{ env.IMAGE_NAME_PREFIX }}/charts/virtrigaud --version ${{ needs.prepare.outputs.version }}
        \`\`\`
        
        ## Security
        
        All images are signed with Cosign and include Software Bill of Materials (SBOMs).
        
        **Full Changelog**: https://github.com/projectbeskar/virtrigaud/compare/${PREV_TAG}...${{ needs.prepare.outputs.tag }}
        EOF

    - name: Upload changelog
      uses: actions/upload-artifact@v4
      with:
        name: changelog
        path: CHANGELOG.md

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare, build-and-push, security-scan, generate-sbom, build-helm-chart, build-cli-tools, generate-changelog]
    steps:
    - name: Download all artifacts (with retry resilience)
      id: download-artifacts
      uses: actions/download-artifact@v4
      continue-on-error: true
      
    - name: Retry failed artifact downloads
      if: steps.download-artifacts.outcome == 'failure'
      run: |
        echo "Initial download failed, attempting selective downloads..."
        
        # Try downloading critical artifacts individually
        for artifact in "helm-chart" "changelog" "cli-tools-linux-amd64" "cli-tools-darwin-amd64" "cli-tools-windows-amd64"; do
          echo "Attempting to download $artifact..."
          gh run download ${{ github.run_id }} --name "$artifact" --dir . || echo "Failed to download $artifact"
        done
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Debug artifact structure
      run: |
        echo "=== Artifact structure ==="
        find . -type f -name "*.tgz" -o -name "*.spdx.json" -o -name "vrtg-*" -o -name "vcts-*" -o -name "virtrigaud-loadgen-*" | head -20
        echo "=== Directory structure ==="
        ls -la
        echo "=== SBOM directories ==="
        ls -la sbom-* 2>/dev/null || echo "No sbom-* directories found"

    - name: Create checksums
      run: |
        # Create checksums for all available release artifacts
        FILES=$(find . -type f \( -name "*.tgz" -o -name "*.spdx.json" -o -name "vrtg-*" -o -name "vcts-*" -o -name "virtrigaud-loadgen-*" \) 2>/dev/null | sort)
        
        if [ -n "$FILES" ]; then
          echo "$FILES" | xargs sha256sum > checksums.txt
          echo "Generated checksums for $(echo "$FILES" | wc -l) files:"
          cat checksums.txt
        else
          echo "Warning: No files found for checksum generation - creating empty checksums.txt"
          touch checksums.txt
        fi

    - name: Prepare release files
      run: |
        # Create a release directory and copy available files
        mkdir -p release-files
        
        # Copy helm charts
        find . -name "*.tgz" -type f -exec cp {} release-files/ \; 2>/dev/null || echo "No helm charts found"
        
        # Copy SBOM files 
        find . -name "*.spdx.json" -type f -exec cp {} release-files/ \; 2>/dev/null || echo "No SBOM files found"
        
        # Copy CLI tools
        find . -name "vrtg-*" -type f -exec cp {} release-files/ \; 2>/dev/null || echo "No vrtg tools found"
        find . -name "vcts-*" -type f -exec cp {} release-files/ \; 2>/dev/null || echo "No vcts tools found"  
        find . -name "virtrigaud-loadgen-*" -type f -exec cp {} release-files/ \; 2>/dev/null || echo "No loadgen tools found"
        
        # Copy checksums
        cp checksums.txt release-files/ 2>/dev/null || echo "No checksums file found"
        
        echo "Release files prepared:"
        ls -la release-files/

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.prepare.outputs.tag }}
        name: Release ${{ needs.prepare.outputs.tag }}
        body_path: changelog/CHANGELOG.md
        files: release-files/*
        prerelease: ${{ contains(needs.prepare.outputs.tag, '-') }}
        fail_on_unmatched_files: false

  publish-helm-chart-oci:
    name: Publish Helm Chart to OCI Registry
    runs-on: ubuntu-latest
    needs: [prepare, build-helm-chart]
    if: github.repository == 'projectbeskar/virtrigaud'
    steps:
    - name: Install Helm
      uses: azure/setup-helm@v3
      with:
        version: '3.12.0'

    - name: Download helm chart
      uses: actions/download-artifact@v4
      with:
        name: helm-chart
        path: ./charts

    - name: Login to GitHub Container Registry
      run: |
        echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ${{ env.REGISTRY }} \
          -u ${{ github.actor }} \
          --password-stdin

    - name: Push Helm chart to OCI registry
      run: |
        CHART_FILE=$(find ./charts -name "*.tgz" | head -1)
        if [ -z "$CHART_FILE" ]; then
          echo "Error: No Helm chart file found"
          exit 1
        fi
        
        # Extract chart name and version from filename
        CHART_BASENAME=$(basename "$CHART_FILE" .tgz)
        CHART_NAME=$(echo "$CHART_BASENAME" | cut -d- -f1)
        CHART_VERSION=$(echo "$CHART_BASENAME" | cut -d- -f2-)
        
        # OCI registry path: ghcr.io/projectbeskar/virtrigaud/charts/virtrigaud
        OCI_REGISTRY="${{ env.REGISTRY }}/${{ env.IMAGE_NAME_PREFIX }}/charts/$CHART_NAME"
        
        echo "Pushing chart to OCI registry: $OCI_REGISTRY"
        echo "Chart file: $CHART_FILE"
        echo "Chart version: $CHART_VERSION"
        
        # Push chart to OCI registry
        # Helm automatically uses the chart version from Chart.yaml
        helm push "$CHART_FILE" "oci://$OCI_REGISTRY"
        
        echo "Successfully published Helm chart to OCI registry"
        echo "OCI Registry: oci://$OCI_REGISTRY"
        echo "Chart version: $CHART_VERSION"
        echo "Install with: helm install virtrigaud oci://$OCI_REGISTRY --version $CHART_VERSION"